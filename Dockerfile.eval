FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY pyproject.toml uv.lock ./
RUN pip install uv && uv sync --frozen

# Copy application code
COPY . .

# Set environment variables with conservative limits
ENV N_SENTENCES=20
ENV MAX_LANGUAGES=150
ENV COST_LIMIT_USD=20

# Create a startup script with cost monitoring and HTTP server
RUN echo '#!/bin/bash\n\
echo "ðŸš€ Starting AI Language Evaluation..."\n\
echo "ðŸ“Š Configuration: $N_SENTENCES sentences, $MAX_LANGUAGES languages"\n\
echo "ðŸ’° Cost limit: $COST_LIMIT_USD USD"\n\
echo "ðŸ›¡ï¸  Cost protection enabled"\n\
\n\
# Start a simple HTTP server to satisfy Cloud Run requirements\n\
python -m http.server 8080 &\n\
HTTP_SERVER_PID=$!\n\
\n\
# Start cost monitoring in background\n\
(\n\
    start_time=$(date +%s)\n\
    while true; do\n\
        current_time=$(date +%s)\n\
        elapsed_hours=$(( (current_time - start_time) / 3600 ))\n\
        if [ $elapsed_hours -ge 24 ]; then\n\
            echo "âš ï¸  MAX RUNTIME REACHED! Stopping evaluation..."\n\
            pkill -f "python evals/main.py"\n\
            break\n\
        fi\n\
        sleep 300  # Check every 5 minutes\n\
    done\n\
) &\n\
\n\
# Run the evaluation\n\
cd /app && uv run python evals/main.py\n\
\n\
# Stop the HTTP server\n\
kill $HTTP_SERVER_PID\n\
\n\
echo "âœ… Evaluation completed!"\n\
' > /app/start.sh && chmod +x /app/start.sh

# Expose port (for Cloud Run requirements)
EXPOSE 8080

# Run the evaluation with resource limits
CMD ["/app/start.sh"] 